name: CD

on:
  release:
    types: [published]
  workflow_dispatch:  # allows manual testing without making a release

jobs:
  build:
    name: Build and Release Prebuilt Binaries
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure and build shared library
        shell: bash
        run: |
          cmake -S . -B build-shared \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_INSTALL_PREFIX=install/shared \
          -DCMAKE_BUILD_TYPE=Release
          cmake --build build-shared --config Release
          cmake --install build-shared --config Release

      - name: Configure and build static library
        shell: bash
        run: |
          cmake -S . -B build-static \
          -DCMAKE_INSTALL_PREFIX=install/static \
          -DCMAKE_BUILD_TYPE=Release
          cmake --build build-static --config Release
          cmake --install build-static --config Release

      - name: Compute package metadata
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          OS_NAME=${{ runner.os }}
          PACKAGE_NAME="mini-sql-$VERSION-$OS_NAME"

          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Package (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          rm -rf package
          mkdir -p package/lib package/include package/cmake

          cp -r install/shared/include/* package/include/
          cp -r install/shared/lib/cmake/mini-sql/* package/cmake/
          if [ "${{ runner.os}}" = "Linux" ]; then
            cp -r install/shared/lib/libminisql.so package/lib/ || true
          else
            cp -r install/shared/lib/libminisql.dylib package/lib/ || true
          fi
          cp -r install/static/lib/libminisql.a package/lib/ || true

          cp LICENSE package/ || true
          cp README.md package/ || true

          ARCHIVE_NAME="$PACKAGE_NAME.tar.gz"
          tar -czf "$PACKAGE_NAME" -C package .

          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force package -ErrorAction SilentlyContinue
          New-Item -ItemType Directory package\lib, package\include, package\cmake | Out-Null

          Copy-Item install\shared\include\* package\include -Recurse
          Copy-Item install\shared\lib\cmake\mini-sql\* package\cmake -Recurse
          Copy-Item install\shared\bin\minisql.dll package\lib -Recurse -ErrorAction SilentlyContinue
          Copy-Item install\static\lib\minisql.lib package\lib -ErrorAction SilentlyContinue

          Copy-Item LICENSE package -ErrorAction SilentlyContinue
          Copy-Item README.md package -ErrorAction SilentlyContinue

          $archive = "$env:PACKAGE_NAME.zip"
          Compress-Archive -Path package\* -DestinationPath $archive

          Add-Content $env:GITHUB_ENV "ARCHIVE_NAME=$archive"

      - name: Upload for testing
        uses: actions/upload-artifact@v4
        with:
          name: prebuilt-binaries
          path: ${{ env.ARCHIVE_NAME }}

      - name: Upload prebuilt archive
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ARCHIVE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}